<%- include('../partials/header', {title: 'Dashboard'}) %>

<div class="dashboard-container">
    <h1 class="mb-4"><i class="fas fa-chart-line me-2"></i>Dashboard</h1>
    
    <% if (typeof error !== 'undefined') { %>
        <div class="alert alert-danger"><%= error %></div>
    <% } %>
    
    <!-- Estatísticas Gerais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-building me-2"></i>Organizações</h5>
                    <p class="card-text display-6"><%= stats.organizationCount %></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-file-invoice-dollar me-2"></i>Faturas</h5>
                    <p class="card-text display-6"><%= stats.billingCount %></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-dollar-sign me-2"></i>Total Faturado</h5>
                    <p class="card-text display-6">$<%= stats.totalAmount.toFixed(2) %></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-clock me-2"></i>Pendente</h5>
                    <p class="card-text display-6">$<%= stats.pendingAmount.toFixed(2) %></p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Faturas Pendentes -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Faturas Pendentes</h5>
                    <a href="/api/billing/status/pending" class="btn btn-sm btn-outline-primary">Ver Todas</a>
                </div>
                <div class="card-body">
                    <% if (pendingBillings && pendingBillings.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Organização</th>
                                        <th>Período</th>
                                        <th>Valor</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% pendingBillings.forEach(function(billing) { %>
                                        <tr>
                                            <td>
                                                <% if (billing.organization && billing.organization.login) { %>
                                                    <%= billing.organization.name || billing.organization.login %>
                                                <% } else { %>
                                                    Organização Desconhecida
                                                <% } %>
                                            </td>
                                            <td><%= billing.month %> <%= billing.year %></td>
                                            <td>$<%= billing.totalAmount.toFixed(2) %></td>
                                            <td>
                                                <a href="/api/billing/<%= billing._id %>" class="btn btn-sm btn-info">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button class="btn btn-sm btn-success mark-paid" data-billing-id="<%= billing._id %>">
                                                    <i class="fas fa-check"></i> Pago
                                                </button>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="alert alert-info">Não há faturas pendentes no momento.</div>
                    <% } %>
                </div>
            </div>
        </div>
        
        <!-- Gráfico de Faturamento -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Distribuição de Faturamento</h5>
                </div>
                <div class="card-body">
                    <canvas id="billingChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Organizações -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-building me-2"></i>Organizações</h5>
            <a href="/api/organizations" class="btn btn-sm btn-primary">
                <i class="fas fa-plus me-1"></i>Adicionar Organização
            </a>
        </div>
        <div class="card-body">
            <% if (organizations && organizations.length > 0) { %>
                <div class="row row-cols-1 row-cols-md-3 g-4">
                    <% organizations.forEach(function(org) { %>
                        <div class="col">
                            <div class="card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <% if (org.avatarUrl) { %>
                                            <img src="<%= org.avatarUrl %>" alt="<%= org.name %>" class="org-avatar me-3">
                                        <% } else { %>
                                            <div class="org-avatar-placeholder me-3">
                                                <%= org.name.charAt(0).toUpperCase() %>
                                            </div>
                                        <% } %>
                                        <h5 class="card-title mb-0"><%= org.name %></h5>
                                    </div>
                                    <% if (org.login) { %>
                                        <p class="card-text text-muted"><small>@<%= org.login %></small></p>
                                    <% } %>
                                </div>
                                <div class="card-footer d-flex justify-content-between">
                                    <a href="/dashboard/organization/<%= org._id %>" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-chart-bar me-1"></i>Detalhes
                                    </a>
                                    <a href="/api/billing/sync/<%= org._id %>" class="btn btn-sm btn-outline-success sync-billing" data-org-id="<%= org._id %>">
                                        <i class="fas fa-sync me-1"></i>Sincronizar
                                    </a>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="alert alert-info">
                    <p>Nenhuma organização cadastrada ainda.</p>
                    <a href="/api/organizations" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Adicionar Organização
                    </a>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script>
// Script para inicializar o gráfico de faturamento
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('billingChart').getContext('2d');
    
    const billingChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Pago', 'Pendente'],
            datasets: [{
                data: [<%= stats.paidAmount %>, <%= stats.pendingAmount %>],
                backgroundColor: ['#28a745', '#ffc107'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Event listener para botões de marcar como pago
    document.querySelectorAll('.mark-paid').forEach(button => {
        button.addEventListener('click', function() {
            const billingId = this.getAttribute('data-billing-id');
            if (confirm('Confirmar marcação como pago?')) {
                updateBillingStatus(billingId, 'paid');
            }
        });
    });
    
    // Event listener para botões de sincronizar faturamento
    document.querySelectorAll('.sync-billing').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const orgId = this.getAttribute('data-org-id');
            syncBillingData(orgId);
        });
    });
});

// Função para atualizar status do faturamento
async function updateBillingStatus(billingId, status) {
    try {
        const response = await fetch(`/api/billing/${billingId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Erro ao atualizar status. Tente novamente.');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao atualizar status. Tente novamente.');
    }
}

// Função para sincronizar dados de faturamento
async function syncBillingData(orgId) {
    try {
        const response = await fetch(`/api/billing/sync/${orgId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('Dados de faturamento sincronizados com sucesso!');
            window.location.reload();
        } else {
            alert('Erro ao sincronizar dados de faturamento. Tente novamente.');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao sincronizar dados de faturamento. Tente novamente.');
    }
}
</script>

<%- include('../partials/footer') %>